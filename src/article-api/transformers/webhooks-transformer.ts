import type { Context, Page } from '@/types'
import type { PageTransformer } from './types'
import { renderContent } from '@/content-render/index'
import { fastTextOnly } from '@/content-render/unified/text-only'
import matter from '@gr2m/gray-matter'

/**
 * Transformer for Webhooks pages.
 * Converts webhook events and payloads into markdown format.
 */
export class WebhooksTransformer implements PageTransformer {
  canTransform(page: Page): boolean {
    return page.autogenerated === 'webhooks'
  }

  async transform(page: Page, pathname: string, context: Context): Promise<string> {
    // Import getInitialPageWebhooks dynamically to avoid circular dependencies
    const { getInitialPageWebhooks } = await import('@/webhooks/lib/index')

    // Extract version from context
    const currentVersion = context.currentVersion!

    // Get the webhook data
    const webhooksData = await getInitialPageWebhooks(currentVersion)

    // Prepare page intro
    const intro = page.intro ? await page.renderProp('intro', context, { textOnly: true }) : ''

    // Build the page header manually to avoid Context type conflicts
    let headerMarkdown = `# ${page.title}\n\n`
    if (intro) {
      headerMarkdown += `${intro}\n\n`
    }

    // Prepare manual content
    let manualContent = ''
    if (page.markdown) {
      const { content } = matter(page.markdown)
      const markerIndex = content.indexOf(
        '<!-- Content after this section is automatically generated -->',
      )

      if (markerIndex > 0) {
        const manualMarkdown = content.substring(0, markerIndex).trim()
        if (manualMarkdown) {
          manualContent = await renderContent(manualMarkdown, {
            ...context,
            markdownRequested: true,
          })
        }
      }
    }

    // Build webhooks sections manually
    let webhooksMarkdown = ''
    for (const webhook of webhooksData) {
      webhooksMarkdown += `## ${webhook.name}\n\n`

      // Summary if available
      if (webhook.data.summaryHtml) {
        const summaryText = fastTextOnly(webhook.data.summaryHtml)
        webhooksMarkdown += `${summaryText}\n\n`
      }

      // Availability
      if (webhook.data.availability && webhook.data.availability.length > 0) {
        webhooksMarkdown += '### Availability\n\n'
        for (const avail of webhook.data.availability) {
          webhooksMarkdown += `- \`${avail}\`\n`
        }
        webhooksMarkdown += '\n'
      }

      // Webhook payload object section
      webhooksMarkdown += '### Webhook payload object\n\n'

      // Available actions
      if (webhook.actionTypes.length > 1) {
        webhooksMarkdown += '**Action type:** '
        const actions = webhook.actionTypes.map((a) => `\`${a}\``).join(', ')
        webhooksMarkdown += `${actions}\n\n`
      }

      // Description if available
      if (webhook.data.descriptionHtml) {
        const descriptionText = fastTextOnly(webhook.data.descriptionHtml)
        webhooksMarkdown += `${descriptionText}\n\n`
      }

      // Body parameters (payload structure)
      if (webhook.data.bodyParameters && webhook.data.bodyParameters.length > 0) {
        webhooksMarkdown += '#### Webhook payload object parameters\n\n'
        webhooksMarkdown += '| Name | Type | Description |\n'
        webhooksMarkdown += '|------|------|-------------|\n'

        for (const param of webhook.data.bodyParameters) {
          const name = param.name ? `\`${param.name}\`` : ''
          const type = param.type ? `\`${param.type}\`` : ''
          // Convert HTML description to plain text
          let desc = param.description || ''
          if (desc) {
            desc = fastTextOnly(desc).replace(/\n/g, ' ').trim()
          }
          // Add required indicator
          if (param.isRequired) {
            desc = `**Required.** ${desc}`
          }

          webhooksMarkdown += `| ${name} | ${type} | ${desc} |\n`
        }
        webhooksMarkdown += '\n'
      }

      // Payload example if available
      if (webhook.data.payloadExample) {
        webhooksMarkdown += '### Webhook payload example\n\n'
        webhooksMarkdown += '```json\n'
        webhooksMarkdown += JSON.stringify(webhook.data.payloadExample, null, 2)
        webhooksMarkdown += '\n```\n\n'
      }
    }

    return `${headerMarkdown + manualContent}\n\n${webhooksMarkdown}`
  }
}
